<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Security: Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net blob:; 
        worker-src blob:; 
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
        font-src https://fonts.gstatic.com; 
        connect-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; 
        img-src 'self' data:;
    ">

    <title>CryptoForge Pro | Developer Cryptography Suite</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* --- DESIGN SYSTEM: DEEP SPACE SLATE --- */
            --bg-app: #0f172a; 
            --bg-sidebar: #0b1120; 
            --bg-card: #1e293b; 
            --bg-input: #0f172a;
            --bg-info: rgba(99, 102, 241, 0.05);
            
            --brand: #6366f1; 
            --brand-glow: rgba(99, 102, 241, 0.15); 
            --brand-hover: #4f46e5;
            
            --secure: #10b981; 
            --warning: #f59e0b; 
            --danger: #ef4444; 
            
            --text-primary: #f8fafc; 
            --text-secondary: #94a3b8; 
            --text-tertiary: #64748b;

            --border: #334155; 
            --border-highlight: #475569;
            
            --radius-md: 12px; 
            --radius-sm: 8px;
            --ease: cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* --- GLOBAL --- */
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-app); color: var(--text-primary); height: 100vh; overflow: hidden; display: flex; }
        :focus-visible { outline: 2px solid var(--brand); outline-offset: 2px; }

        /* --- ICONS --- */
        .icon { width: 18px; height: 18px; stroke-width: 2; stroke: currentColor; fill: none; }
        .icon-sm { width: 15px; height: 15px; }

        /* --- LAYOUT --- */
        .sidebar { 
            width: 280px; 
            background: linear-gradient(180deg, var(--bg-sidebar) 0%, #020617 100%); 
            border-right: 1px solid var(--border); 
            display: flex; flex-direction: column; 
            padding: 24px 16px; flex-shrink: 0; z-index: 10; 
        }
        .main-content { flex: 1; overflow-y: auto; padding: 40px; position: relative; scroll-behavior: smooth; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-tertiary); }

        /* --- COMPONENTS --- */
        .brand-block { margin-bottom: 24px; padding: 0 12px; cursor: pointer; }
        .brand-title { font-size: 1.25rem; font-weight: 700; letter-spacing: -0.03em; background: linear-gradient(135deg, #fff 0%, #94a3b8 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .brand-subtitle { font-size: 0.7rem; color: var(--brand); font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; margin-top: 4px; opacity: 0.9; }

        /* Search Bar */
        .search-container { position: relative; margin-bottom: 24px; }
        .search-input {
            width: 100%; background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            border-radius: var(--radius-sm); padding: 10px 12px 10px 36px;
            color: var(--text-primary); font-size: 0.85rem; transition: all 0.2s;
        }
        .search-input:focus { border-color: var(--brand); background: var(--bg-input); }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary); width: 16px; height: 16px; }

        .nav-menu { display: flex; flex-direction: column; gap: 4px; flex: 1; }
        .nav-item { 
            padding: 10px 12px; border-radius: var(--radius-sm); cursor: pointer; 
            color: var(--text-secondary); font-size: 0.9rem; font-weight: 500; 
            display: flex; align-items: center; gap: 12px; transition: all 0.2s var(--ease); 
            border: 1px solid transparent;
        }
        .nav-item:hover { background: rgba(255, 255, 255, 0.03); color: var(--text-primary); }
        .nav-item.active { 
            background: rgba(99, 102, 241, 0.1); 
            color: var(--brand); 
            font-weight: 600; 
            border-color: rgba(99, 102, 241, 0.2);
        }

        .view-section { display: none; max-width: 900px; margin: 0 auto; animation: fadeUp 0.5s var(--ease); }
        .view-section.active { display: block; }

        /* Headers & Text */
        h1 { font-size: 1.75rem; font-weight: 700; margin: 0 0 8px 0; color: var(--text-primary); }
        p.desc { color: var(--text-secondary); margin: 0 0 24px 0; font-size: 0.95rem; line-height: 1.6; max-width: 650px; }
        h2 { font-size: 0.9rem; font-weight: 600; margin: 28px 0 12px 0; color: var(--text-tertiary); display: flex; align-items: center; gap: 10px; text-transform: uppercase; letter-spacing: 0.05em; }
        
        .badge { font-size: 0.65rem; padding: 3px 8px; border-radius: 4px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .badge.secure { background: rgba(16, 185, 129, 0.1); color: var(--secure); border: 1px solid rgba(16, 185, 129, 0.2); }
        .badge.legacy { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }
        
        /* Info Box */
        details.info-box {
            background: var(--bg-info); border: 1px solid var(--brand-glow);
            border-radius: var(--radius-sm); margin-bottom: 32px;
            overflow: hidden; transition: all 0.3s var(--ease);
        }
        details.info-box summary {
            padding: 12px 16px; cursor: pointer; font-size: 0.85rem; font-weight: 600;
            color: var(--brand); list-style: none; display: flex; align-items: center; gap: 8px;
        }
        details.info-box summary::-webkit-details-marker { display: none; }
        details.info-box summary::after { content: '+'; margin-left: auto; font-weight: 400; font-size: 1.1em; }
        details.info-box[open] summary::after { content: '-'; }
        
        .info-content {
            padding: 16px; border-top: 1px solid rgba(99, 102, 241, 0.1);
            font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6;
        }
        .info-content strong { color: var(--text-primary); }
        .info-content ul { margin: 8px 0 0 0; padding-left: 20px; }
        .info-content li { margin-bottom: 6px; }

        /* Cards & Inputs */
        .card { 
            background: var(--bg-card); border: 1px solid var(--border); 
            border-radius: var(--radius-md); padding: 24px; margin-bottom: 24px; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
        }
        label { display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500; }
        .input-group { position: relative; margin-bottom: 20px; }
        
        textarea, input[type="text"], input[type="password"], input[type="number"], select { 
            width: 100%; background: var(--bg-input); border: 1px solid var(--border); 
            color: var(--text-primary); padding: 14px 16px; border-radius: var(--radius-sm); 
            font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; transition: all 0.2s; 
        }
        textarea:focus, input:focus, select:focus { border-color: var(--brand); box-shadow: 0 0 0 3px var(--brand-glow); }

        /* Tabs */
        .inner-tabs { display: flex; gap: 20px; margin-bottom: 24px; border-bottom: 1px solid var(--border); padding-bottom: 0px; }
        .inner-tab { 
            cursor: pointer; font-size: 0.9rem; color: var(--text-secondary); 
            padding: 0 0 12px 0; position: relative; transition: color 0.2s; 
        }
        .inner-tab:hover { color: var(--text-primary); }
        .inner-tab.active { color: var(--brand); font-weight: 600; }
        .inner-tab.active::after { 
            content: ''; position: absolute; bottom: -1px; left: 0; right: 0; 
            height: 2px; background: var(--brand); border-radius: 2px 2px 0 0;
        }

        /* Drag Drop */
        .drop-zone { 
            border: 2px dashed var(--border); border-radius: var(--radius-sm); 
            padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s; 
            background: var(--bg-input); 
        }
        .drop-zone:hover, .drop-zone.dragover { border-color: var(--brand); background: rgba(99, 102, 241, 0.05); }

        /* Hash List & Items (UPDATED ALIGNMENT 2.0) */
        .hash-list { display: flex; flex-direction: column; gap: 12px; }
        
        .hash-item { 
            background: rgba(2, 6, 23, 0.3); border: 1px solid var(--border); 
            border-radius: var(--radius-sm); padding: 0; 
            display: grid; grid-template-columns: 140px 1fr auto; /* Changed last col to auto */
            align-items: stretch; 
            transition: all 0.2s; overflow: hidden; min-height: 48px;
        }
        .hash-item:hover { border-color: var(--border-highlight); background: rgba(2, 6, 23, 0.5); }
        
        .algo-label { 
            font-size: 0.75rem; font-weight: 700; color: var(--text-tertiary); 
            text-transform: uppercase; display: flex; align-items: center; 
            background: rgba(255,255,255,0.02); padding: 0 16px;
            border-right: 1px solid rgba(255,255,255,0.03);
        }
        
        .hash-val { 
            font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; 
            color: var(--text-secondary); white-space: nowrap; overflow: hidden; 
            text-overflow: ellipsis; padding: 12px 16px; display: flex; align-items: center;
        }
        .hash-val.highlight { color: var(--text-primary); font-weight: 500; }
        .hash-val.disabled { font-style: italic; color: var(--text-tertiary); }

        /* Action Buttons Container */
        .hash-actions {
            display: flex;
            height: 100%;
            border-left: 1px solid rgba(255,255,255,0.03);
        }

        .btn-icon { 
            background: transparent; border: none; color: var(--text-tertiary); 
            cursor: pointer; width: 44px; height: 100%; display: flex; 
            align-items: center; justify-content: center; transition: all 0.2s; 
            border-left: 1px solid transparent;
        }
        /* Border separator between grouped buttons */
        .btn-icon:first-child { border-right: 1px solid rgba(255,255,255,0.03); }
        
        .btn-icon:hover { background: var(--bg-input); color: var(--brand); }
        
        .btn-primary { background: var(--brand); color: white; border: none; padding: 10px 20px; border-radius: var(--radius-sm); font-weight: 600; cursor: pointer; font-size: 0.85rem; transition: background 0.2s; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
        .btn-primary:hover { background: var(--brand-hover); transform: translateY(-1px); }
        
        .btn-outline { 
            background: transparent; border: 1px solid var(--border); 
            color: var(--text-secondary); padding: 8px 12px; 
            border-radius: var(--radius-sm); font-weight: 500; 
            cursor: pointer; font-size: 0.8rem; transition: all 0.2s; 
            display: inline-flex; align-items: center; gap: 6px;
        }
        .btn-outline:hover { border-color: var(--text-primary); color: var(--text-primary); background: rgba(255,255,255,0.02); }

        /* Threat Grid */
        .threat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px; }
        .threat-card { background: var(--bg-input); border: 1px solid var(--border); padding: 16px; border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s; text-align: center; }
        .threat-card:hover { border-color: var(--brand); }
        .threat-card.selected { border-color: var(--brand); background: var(--brand-glow); box-shadow: 0 0 0 1px var(--brand); }
        .threat-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 4px; display: block; }
        .threat-desc { font-size: 0.75rem; color: var(--text-secondary); }
        
        /* Dynamic Explain Box */
        .explain-box {
            background: var(--bg-app); border: 1px solid var(--border);
            border-radius: var(--radius-sm); padding: 12px; margin-bottom: 24px;
            font-size: 0.85rem; color: var(--text-secondary); line-height: 1.5;
            display: flex; gap: 10px; align-items: flex-start;
        }
        .explain-icon { color: var(--brand); margin-top: 2px; flex-shrink: 0; }

        /* Avalanche */
        .avalanche-container { margin-top: 24px; padding: 20px; background: #020617; border-radius: var(--radius-sm); border: 1px solid var(--border); }
        .bit-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(8px, 1fr)); gap: 2px; margin-top: 12px; }
        .bit { height: 8px; background: #1e293b; border-radius: 1px; transition: background 0.3s; }
        .bit.active { background: var(--brand); box-shadow: 0 0 4px var(--brand); }
        .bit.diff { background: var(--danger); box-shadow: 0 0 4px var(--danger); }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 100; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); width: 90%; max-width: 500px; padding: 32px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); transform: translateY(20px); transition: transform 0.2s; }
        .modal-overlay.open .modal { transform: translateY(0); }
        .modal h2 { margin-top: 0; color: var(--brand); }
        .modal ul { padding-left: 20px; color: var(--text-secondary); line-height: 1.6; }
        .modal li { margin-bottom: 8px; }

        /* Toast */
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--text-primary); color: var(--bg-app); padding: 12px 24px; border-radius: 50px; font-weight: 600; opacity: 0; pointer-events: none; transition: all 0.3s var(--ease); z-index: 200; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 8px; }
        #toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* Utilities */
        .hidden { display: none !important; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .info-tip { cursor: help; opacity: 0.5; transition: opacity 0.2s; }
        .info-tip:hover { opacity: 1; color: var(--text-primary); }

        @media (max-width: 768px) {
            body { flex-direction: column; overflow-y: auto; }
            .sidebar { width: 100%; flex-direction: row; align-items: center; justify-content: space-between; padding: 12px; border-right: none; border-bottom: 1px solid var(--border); background: var(--bg-sidebar); }
            .search-container { display: none; } /* Hide search on mobile for space */
            .nav-menu { display: none; } /* Use a mobile menu in real prod */
            .main-content { padding: 20px 16px; overflow: visible; }
            .threat-grid { grid-template-columns: 1fr; }
        }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- SVG DEFS -->
    <svg style="display: none;">
        <symbol id="icon-hash" viewBox="0 0 24 24"><path d="M4 9h16M4 15h16M10 3L8 21M16 3l-2 18" stroke-linecap="round" stroke-linejoin="round"/></symbol>
        <symbol id="icon-key" viewBox="0 0 24 24"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" stroke-linecap="round" stroke-linejoin="round"/></symbol>
        <symbol id="icon-lock" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></symbol>
        <symbol id="icon-code" viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></symbol>
        <symbol id="icon-compare" viewBox="0 0 24 24"><path d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l-5 5M4 4l5 5" stroke-linecap="round" stroke-linejoin="round"/></symbol>
        <symbol id="icon-copy" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></symbol>
        <symbol id="icon-refresh" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></symbol>
        <symbol id="icon-zap" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></symbol>
        <symbol id="icon-search" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></symbol>
        <symbol id="icon-info" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></symbol>
        <symbol id="icon-terminal" viewBox="0 0 24 24"><polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line></symbol>
    </svg>

    <!-- SIDEBAR -->
    <nav class="sidebar">
        <div class="brand-block" onclick="toggleModal('security-modal')">
            <div class="brand-title">CryptoForge</div>
            <div class="brand-subtitle">PRO SUITE</div>
        </div>

        <div class="search-container">
            <svg class="icon search-icon"><use href="#icon-search"/></svg>
            <input type="text" class="search-input" id="global-search" placeholder="Search tools (e.g. uuid)...">
        </div>
        
        <div class="nav-menu" style="display:flex;">
            <div class="nav-item active" data-target="hash-view" onclick="switchTab('hash-view', this)">
                <svg class="icon"><use href="#icon-hash"/></svg> <span>Hash Studio</span>
            </div>
            <div class="nav-item" data-target="gen-view" onclick="switchTab('gen-view', this)">
                <svg class="icon"><use href="#icon-key"/></svg> <span>Key Lab</span>
            </div>
            <div class="nav-item" data-target="password-view" onclick="switchTab('password-view', this)">
                <svg class="icon"><use href="#icon-lock"/></svg> <span>Password Foundry</span>
            </div>
            <div class="nav-item" data-target="hmac-view" onclick="switchTab('hmac-view', this)">
                <svg class="icon"><use href="#icon-zap"/></svg> <span>HMAC Signer</span>
            </div>
            <div class="nav-item" data-target="utils-view" onclick="switchTab('utils-view', this)">
                <svg class="icon"><use href="#icon-code"/></svg> <span>Encoders</span>
            </div>
            <div class="nav-item" data-target="compare-view" onclick="switchTab('compare-view', this)">
                <svg class="icon"><use href="#icon-compare"/></svg> <span>Comparator</span>
            </div>
            
            <div style="flex: 1"></div>
            
            <div class="nav-item" onclick="toggleZeroTrust()" id="zt-btn" style="border: 1px solid var(--border); margin-top: auto;">
                <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--secure);" id="zt-dot"></div>
                <span id="zt-text">Libs: OFF</span>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        
        <!-- HASH STUDIO -->
        <section id="hash-view" class="view-section active">
            <header class="flex-between">
                <div><h1>Hash Studio</h1><p class="desc">Secure Checksums (SHA-2/3) & Legacy Hashes.</p></div>
                <button class="btn-outline" onclick="downloadReport()">Save Report</button>
            </header>

            <details class="info-box">
                <summary><svg class="icon icon-sm"><use href="#icon-info"/></svg> How it works</summary>
                <div class="info-content">
                    <strong>Hash Functions</strong> map data of arbitrary size to fixed-size values. They are one-way functions used for data integrity.
                    <ul>
                        <li><strong>SHA-256/512:</strong> The industry standard. Use for checksums, digital signatures, and general integrity. Secure.</li>
                        <li><strong>SHA-3 (Keccak):</strong> The newest NIST standard. Distinct internal structure from SHA-2. High security margin.</li>
                        <li><strong>MD5/SHA-1:</strong> <span style="color:var(--danger)">Legacy.</span> Vulnerable to collision attacks. Use only for compatibility.</li>
                    </ul>
                </div>
            </details>

            <div class="card">
                <div class="inner-tabs">
                    <div class="inner-tab active" id="tab-text" onclick="setHashMode('text')">Text Input</div>
                    <div class="inner-tab" id="tab-file" onclick="setHashMode('file')">File Checksum</div>
                </div>

                <!-- Text Mode -->
                <div id="mode-text">
                    <div class="input-group">
                        <textarea id="hash-input" rows="3" placeholder="Enter text to hash (Ctrl+Enter to calc)..."></textarea>
                    </div>
                </div>

                <!-- File Mode -->
                <div id="mode-file" class="hidden">
                    <div class="drop-zone" id="drop-zone">
                        <svg class="icon" style="width: 48px; height: 48px; color: var(--text-tertiary); margin-bottom: 12px;"><use href="#icon-code"/></svg>
                        <p style="margin:0; font-weight:600; color:var(--text-primary)">Drag file here</p>
                        <p style="margin:4px 0 0 0; font-size:0.8rem; color:var(--text-tertiary)">Calculated locally via WebCrypto</p>
                        <input type="file" id="file-input" style="display:none">
                    </div>
                    <div id="file-info" style="margin-top:12px; font-size:0.85rem; color:var(--brand); font-weight:500;"></div>
                </div>

                <h2 style="margin-top: 24px;">Recommended <span class="badge secure">Secure</span></h2>
                <div class="hash-list">
                    <div class="hash-item">
                        <div class="algo-label">SHA-256</div>
                        <div class="hash-val highlight" id="out-sha256"></div>
                        <div class="hash-actions">
                            <button class="btn-icon" onclick="copyHashCLI('SHA-256')" title="Copy Node.js CLI Command"><svg class="icon icon-sm"><use href="#icon-terminal"/></svg></button>
                            <button class="btn-icon" onclick="copy('out-sha256')" title="Copy Hash"><svg class="icon icon-sm"><use href="#icon-copy"/></svg></button>
                        </div>
                    </div>
                    <div class="hash-item">
                        <div class="algo-label">SHA-512</div>
                        <div class="hash-val" id="out-sha512"></div>
                        <div class="hash-actions">
                            <button class="btn-icon" onclick="copyHashCLI('SHA-512')" title="Copy Node.js CLI Command"><svg class="icon icon-sm"><use href="#icon-terminal"/></svg></button>
                            <button class="btn-icon" onclick="copy('out-sha512')" title="Copy Hash"><svg class="icon icon-sm"><use href="#icon-copy"/></svg></button>
                        </div>
                    </div>
                </div>

                <div id="legacy-container" class="hidden">
                    <h2>Legacy / Libs <span class="badge legacy">External</span></h2>
                    <div class="hash-list">
                        <div class="hash-item">
                            <div class="algo-label">SHA-3 (Keccak)</div>
                            <div class="hash-val" id="out-sha3"></div>
                            <div class="hash-actions">
                                <button class="btn-icon" onclick="copyHashCLI('SHA-3')" title="Copy Node.js CLI Command"><svg class="icon icon-sm"><use href="#icon-terminal"/></svg></button>
                                <button class="btn-icon" onclick="copy('out-sha3')" title="Copy Hash"><svg class="icon icon-sm"><use href="#icon-copy"/></svg></button>
                            </div>
                        </div>
                        <div class="hash-item">
                            <div class="algo-label">MD5 (Broken)</div>
                            <div class="hash-val" id="out-md5"></div>
                            <div class="hash-actions">
                                <button class="btn-icon" onclick="copyHashCLI('MD5')" title="Copy Node.js CLI Command"><svg class="icon icon-sm"><use href="#icon-terminal"/></svg></button>
                                <button class="btn-icon" onclick="copy('out-md5')" title="Copy Hash"><svg class="icon icon-sm"><use href="#icon-copy"/></svg></button>
                            </div>
                        </div>
                        <div class="hash-item">
                            <div class="algo-label">RIPEMD-160</div>
                            <div class="hash-val" id="out-ripemd"></div>
                            <div class="hash-actions">
                                <button class="btn-icon" onclick="copyHashCLI('RIPEMD-160')" title="Copy Node.js CLI Command"><svg class="icon icon-sm"><use href="#icon-terminal"/></svg></button>
                                <button class="btn-icon" onclick="copy('out-ripemd')" title="Copy Hash"><svg class="icon icon-sm"><use href="#icon-copy"/></svg></button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="legacy-warning" style="margin-top: 20px; padding: 12px; border: 1px dashed var(--border); border-radius: var(--radius-sm); color: var(--text-tertiary); font-size: 0.85rem; text-align: center;">
                    Enable <strong>External Libraries</strong> to use SHA-3, MD5, Argon2, and Legacy Hashes.
                </div>
            </div>
        </section>

        <!-- GENERATOR / KEY LAB -->
        <section id="gen-view" class="view-section">
            <header><h1>Key Lab</h1><p class="desc">Generate cryptographically secure random values (CSPRNG) suitable for encryption keys and secrets.</p></header>

            <details class="info-box">
                <summary><svg class="icon icon-sm"><use href="#icon-info"/></svg> How it works</summary>
                <div class="info-content">
                    Uses the browser's <code>window.crypto.getRandomValues()</code> CSPRNG to generate high-entropy noise. 
                    <ul>
                        <li><strong>Master Keys:</strong> 32-byte (256-bit) values are standard for AES-256 encryption.</li>
                        <li><strong>UUID v4:</strong> Universally Unique Identifiers based on random numbers. Collision probability is astronomically low.</li>
                    </ul>
                </div>
            </details>

            <div class="card">
                <!-- Encryption Key (32 bytes) -->
                <div style="margin-bottom: 24px;">
                    <div class="flex-between" style="margin-bottom: 8px;">
                        <label>Encryption Master Key (256-bit Base64)</label>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-outline" onclick="copyToClipboard('node -e &quot;console.log(require(\'crypto\').randomBytes(32).toString(\'base64\'))&quot;')" title="Copy Node.js Command">
                                <svg class="icon icon-sm"><use href="#icon-terminal"/></svg> CLI
                            </button>
                            <button class="btn-outline" onclick="genKey(32, 'b64', 'out-gen-enc')">
                                <svg class="icon icon-sm"><use href="#icon-refresh"/></svg> Regenerate
                            </button>
                        </div>
                    </div>
                    <div class="hash-list">
                        <div class="hash-item">
                            <div class="algo-label">B64</div>
                            <div class="hash-val highlight" id="out-gen-enc" style="color: var(--brand);"></div>
                            <div class="hash-actions">
                                <button class="btn-icon" onclick="copy('out-gen-enc')"><svg class="icon icon-sm"><use href="#icon-copy"/></svg></button>
                            </div>
                        </div>
                    </div>
                    <p style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 6px;">Equivalent to: <code>node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"</code></p>
                </div>

                <!-- Hex Secret -->
                <div style="margin-bottom: 24px;">
                    <div class="flex-between" style="margin-bottom: 8px;">
                        <label>HMAC Secret / API Key (Hex)</label>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-outline" onclick="copyToClipboard('node -e &quot;console.log(require(\'crypto\').randomBytes(32).toString(\'hex\'))&quot;')" title="Copy Node.js Command">
                                <svg class="icon icon-sm"><use href="#icon-terminal"/></svg> CLI
                            </button>
                            <button class="btn-outline" onclick="genKey(32, 'hex', 'out-gen-hex')">
                                <svg class="icon icon-sm"><use href="#icon-refresh"/></svg> Regenerate
                            </button>
                        </div>
                    </div>
                    <div class="hash-list">
                        <div class="hash-item">
                            <div class="algo-label">HEX</div>
                            <div class="hash-val" id="out-gen-hex"></div>
                            <div class="hash-actions">
                                <button class="btn-icon" onclick="copy('out-gen-hex')"><svg class="icon icon-sm"><use href="#icon-copy"/></svg></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- UUID -->
                <div>
                    <div class="flex-between" style="margin-bottom: 8px;">
                        <label>UUID v4</label>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-outline" onclick="copyToClipboard('node -e &quot;console.log(require(\'crypto\').randomUUID())&quot;')" title="Copy Node.js Command">
                                <svg class="icon icon-sm"><use href="#icon-terminal"/></svg> CLI
                            </button>
                            <button class="btn-outline" onclick="genUUID()">
                                <svg class="icon icon-sm"><use href="#icon-refresh"/></svg> Regenerate
                            </button>
                        </div>
                    </div>
                    <div class="hash-list">
                        <div class="hash-item">
                            <div class="algo-label">UUID</div>
                            <div class="hash-val" id="out-gen-uuid"></div>
                            <div class="hash-actions">
                                <button class="btn-icon" onclick="copy('out-gen-uuid')"><svg class="icon icon-sm"><use href="#icon-copy"/></svg></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- PASSWORD FOUNDRY -->
        <section id="password-view" class="view-section">
            <header><h1>Password Foundry</h1><p class="desc">Compare KDF (Key Derivation Function) algorithms used for password storage.</p></header>

            <details class="info-box">
                <summary><svg class="icon icon-sm"><use href="#icon-info"/></svg> Understanding Cost Factors</summary>
                <div class="info-content">
                    KDFs are designed to be slow to resist brute-force attacks.
                    <ul>
                        <li><strong>Cost 10:</strong> Baseline. ~100ms. Good for development and testing.</li>
                        <li><strong>Cost 12:</strong> Standard. ~300-500ms. Recommended for most web applications.</li>
                        <li><strong>Cost 14:</strong> High. ~1-2s. Use for banking or root access protection.</li>
                    </ul>
                </div>
            </details>

            <div class="card">
                <div class="inner-tabs">
                    <div class="inner-tab active" onclick="setKDF('bcrypt', this)">Bcrypt</div>
                    <div class="inner-tab" onclick="setKDF('pbkdf2', this)">PBKDF2 (Native)</div>
                    <div class="inner-tab" onclick="setKDF('argon2', this)">Argon2 (WASM)</div>
                </div>

                <!-- Threat Model UI (Shared) -->
                <div class="threat-grid">
                    <div class="threat-card selected" onclick="setThreat(10, this)"><span class="threat-title">Dev / Test</span><span class="threat-desc">Cost 10</span></div>
                    <div class="threat-card" onclick="setThreat(12, this)"><span class="threat-title">Identity</span><span class="threat-desc">Cost 12</span></div>
                    <div class="threat-card" onclick="setThreat(14, this)"><span class="threat-title">High Security</span><span class="threat-desc">Cost 14</span></div>
                </div>

                <!-- Dynamic Explanation -->
                <div class="explain-box">
                    <svg class="icon explain-icon"><use href="#icon-info"/></svg>
                    <span id="threat-explain"><strong>Cost 10:</strong> Light hashing. Calculates in ~100ms. Suitable for development environments where speed is prioritized over maximum resistance.</span>
                </div>

                <div class="input-group">
                    <input type="text" id="pwd-input" placeholder="Enter password...">
                </div>
                
                <div class="hash-item" style="background: rgba(0,0,0,0.3); padding: 0;">
                    <div class="algo-label" id="kdf-label">BCRYPT</div>
                    <div class="hash-val highlight" id="out-kdf" style="white-space: pre-wrap; word-break: break-all;">Waiting for input...</div>
                    <div class="hash-actions">
                        <button class="btn-icon" onclick="copy('out-kdf')"><svg class="icon icon-sm"><use href="#icon-copy"/></svg></button>
                    </div>
                </div>
                <div id="kdf-status" style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 12px; display: flex; align-items: center; gap: 8px;">Worker Idle</div>
            </div>
        </section>

        <!-- HMAC SIGNER -->
        <section id="hmac-view" class="view-section">
            <header><h1>HMAC Signer</h1><p class="desc">Native WebCrypto signing for API Auth & JWT.</p></header>

            <details class="info-box">
                <summary><svg class="icon icon-sm"><use href="#icon-info"/></svg> How it works</summary>
                <div class="info-content">
                    HMAC (Hash-based Message Authentication Code) uses a cryptographic hash function and a secret key.
                    <ul>
                        <li><strong>Integrity & Authenticity:</strong> Verifies that data has not been changed and comes from a specific sender.</li>
                        <li><strong>Usage:</strong> Webhooks (Stripe/GitHub), API Authentication, and JSON Web Tokens (JWT).</li>
                    </ul>
                </div>
            </details>

            <div class="card">
                <label>Secret Key</label>
                <div class="input-group"><input type="password" id="hmac-key" placeholder="Signing Key..."></div>
                <label>Payload</label>
                <div class="input-group"><textarea id="hmac-payload" rows="2" placeholder="Data to sign..."></textarea></div>
                <div class="hash-list">
                    <div class="hash-item">
                        <div class="algo-label">HMAC-SHA256</div>
                        <div class="hash-val highlight" id="out-hmac256"></div>
                        <div class="hash-actions">
                            <button class="btn-icon" onclick="copy('out-hmac256')"><svg class="icon icon-sm"><use href="#icon-copy"/></svg></button>
                        </div>
                    </div>
                    <div class="hash-item">
                        <div class="algo-label">HMAC-SHA512</div>
                        <div class="hash-val" id="out-hmac512"></div>
                        <div class="hash-actions">
                            <button class="btn-icon" onclick="copy('out-hmac512')"><svg class="icon icon-sm"><use href="#icon-copy"/></svg></button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- UTILS -->
        <section id="utils-view" class="view-section">
            <header><h1>Encoders</h1><p class="desc">Format conversion utilities.</p></header>

            <details class="info-box">
                <summary><svg class="icon icon-sm"><use href="#icon-info"/></svg> How it works</summary>
                <div class="info-content">
                    Encoders change the representation of data, not the data itself.
                    <ul>
                        <li><strong>Base64:</strong> Represents binary data in ASCII string format. Commonly used in email and data URIs.</li>
                        <li><strong>URL Encoded:</strong> Safe encoding for URL parameters (e.g. spaces become %20).</li>
                    </ul>
                </div>
            </details>

            <div class="card">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div><label>Input</label><textarea id="enc-input" rows="5" placeholder="Text..." oninput="runEncoders()"></textarea></div>
                    <div style="display:flex; flex-direction:column; gap:12px;">
                        <label>Outputs</label>
                        <div class="hash-item" style="display:block;">
                            <div class="flex-between" style="margin-bottom: 4px;"><div class="algo-label">Base64</div><button class="btn-icon" style="width:auto;" onclick="copy('out-b64')"><svg class="icon icon-sm"><use href="#icon-copy"/></svg></button></div><div class="hash-val highlight" id="out-b64" style="padding: 4px 16px;"></div>
                        </div>
                        <div class="hash-item" style="display:block;">
                            <div class="flex-between" style="margin-bottom: 4px;"><div class="algo-label">URL Encoded</div><button class="btn-icon" style="width:auto;" onclick="copy('out-url')"><svg class="icon icon-sm"><use href="#icon-copy"/></svg></button></div><div class="hash-val" id="out-url" style="padding: 4px 16px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- COMPARATOR -->
        <section id="compare-view" class="view-section">
            <header><h1>Comparator</h1><p class="desc">Visual Avalanche Effect (Bit Diff).</p></header>

            <details class="info-box">
                <summary><svg class="icon icon-sm"><use href="#icon-info"/></svg> How it works</summary>
                <div class="info-content">
                    <strong>The Avalanche Effect</strong> is a desirable property of cryptographic algorithms.
                    <ul>
                        <li><strong>Concept:</strong> A tiny change in input (e.g., flipping 1 bit) should change at least 50% of the output bits significantly.</li>
                        <li><strong>Visualization:</strong> The grid below represents the 256 bits of a SHA-256 hash. Red squares indicate bits that flipped between Input A and Input B.</li>
                    </ul>
                </div>
            </details>

            <div class="card">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div><label>Input A</label><input type="text" id="comp-a" value="Hello World" oninput="runCompare()"></div>
                    <div><label>Input B</label><input type="text" id="comp-b" value="Hello world" oninput="runCompare()"></div>
                </div>
                <div class="avalanche-container">
                    <div class="flex-between"><label>Bit Difference</label><span id="diff-pct" style="color:var(--brand); font-weight:700;">0%</span></div>
                    <div id="bit-grid" class="bit-grid"></div>
                </div>
            </div>
        </section>
    </main>

    <!-- TOAST -->
    <div id="toast" role="status" aria-live="polite">
        <svg class="icon"><use href="#icon-copy"/></svg> Copied to clipboard
    </div>

    <!-- SECURITY MODAL -->
    <div id="security-modal" class="modal-overlay" onclick="if(event.target === this) toggleModal('security-modal')">
        <div class="modal">
            <h2>Threat Model</h2>
            <ul>
                <li><strong>Local Execution:</strong> All operations run in your browser (WebCrypto API). No data is sent to any server.</li>
                <li><strong>Zero-Trust:</strong> External libraries are blocked by default. Enable them only if you need legacy algorithms (MD5) or Bcrypt/Argon2.</li>
                <li><strong>Non-Persistence:</strong> Keys and passwords are NOT saved to localStorage.</li>
                <li><strong>Disclaimer:</strong> Use generated secrets for development. For production, ensure entropy sources match your specific compliance requirements.</li>
            </ul>
            <div style="margin-top: 20px; font-size: 0.8rem; color: var(--text-tertiary); text-align: center;">
                Compatible with GitHub Pages. Rename to <code>index.html</code> to deploy.
            </div>
            <button class="btn-primary" style="width:100%; margin-top: 12px;" onclick="toggleModal('security-modal')">Understood</button>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // --- 1. STATE & CORE ---
        const State = {
            libsLoaded: false,
            kdfMode: 'bcrypt',
            currentCost: 10,
            hashMode: 'text'
        };

        const get = (id) => document.getElementById(id);
        
        // --- 2. LIBRARY LOADER (LAZY) ---
        // Using Bundled Argon2 to ensure WASM is included inline or loaded correctly for Single-File use
        const LIBS = {
            bcrypt: { url: 'https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js', integrity: 'sha512-DNI/FJdkfyeuPUal7lDkRVg0mFY2n4IZJJYqPbQWLL0COxLi6G6nmf5gr1vW1Bd4wYC09hOvZVsSclfXxUTU/w==' },
            cryptojs: { url: 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js', integrity: 'sha512-E8QSvWZ0eCLGk4km3hxSsNmGWbLtSCSUcewDQPQWZF6pEU8GlT8a5fF32wOl1i8ftdMhssTrF/OhyGWwonTcXA==' },
            // UPDATED: Using Bundled version which handles WASM better for simple deployments
            argon2: { url: 'https://cdn.jsdelivr.net/npm/argon2-browser@1.18.0/dist/argon2-bundled.min.js' } 
        };

        function loadScript(libName) {
            return new Promise((resolve, reject) => {
                const lib = LIBS[libName];
                if (document.querySelector(`script[src="${lib.url}"]`)) return resolve();
                
                const s = document.createElement('script');
                s.src = lib.url;
                if(lib.integrity) {
                    s.integrity = lib.integrity;
                    s.crossOrigin = 'anonymous';
                }
                s.onload = resolve;
                s.onerror = reject;
                document.head.appendChild(s);
            });
        }

        async function toggleZeroTrust() {
            const btn = get('zt-btn');
            const dot = get('zt-dot');
            const txt = get('zt-text');
            const legContainer = get('legacy-container');
            const legWarn = get('legacy-warning');

            if (!State.libsLoaded) {
                // ENABLE LIBS
                txt.innerText = "Loading...";
                try {
                    await Promise.all([loadScript('bcrypt'), loadScript('cryptojs'), loadScript('argon2')]);
                    State.libsLoaded = true;
                    localStorage.setItem('cf_libs', 'true');
                    
                    dot.style.background = 'var(--warning)'; // Amber = Libs Active
                    txt.innerText = "Libs: ON";
                    legContainer.classList.remove('hidden');
                    legWarn.classList.add('hidden');
                    
                    initBcryptWorker(); // Start worker now that lib is ready
                    updateHashStudio(); // Re-run hashes
                } catch(e) {
                    alert("Failed to load libraries. Check internet connection.");
                    txt.innerText = "Load Failed";
                }
            } else {
                // DISABLE LIBS (Soft reset, reload required for true unload)
                if(confirm("To fully unload libraries, the page will reload. Continue?")) {
                    localStorage.setItem('cf_libs', 'false');
                    location.reload();
                }
            }
        }

        // --- 3. KEY GENERATORS ---
        function genKey(bytes, format, outputId) {
            const arr = new Uint8Array(bytes);
            window.crypto.getRandomValues(arr);
            
            let result = '';
            if (format === 'hex') {
                result = [...arr].map(b => b.toString(16).padStart(2,'0')).join('');
            } else if (format === 'b64') {
                // Binary to Base64 (Standard)
                let binary = '';
                arr.forEach(b => binary += String.fromCharCode(b));
                result = window.btoa(binary);
            }
            get(outputId).innerText = result;
        }

        function genUUID() {
            get('out-gen-uuid').innerText = crypto.randomUUID();
        }

        // --- 4. WORKERS & ALGOS ---
        
        // Bcrypt Worker (Inline Blob)
        let bcryptWorker;
        function initBcryptWorker() {
            if(!State.libsLoaded || bcryptWorker) return;
            const code = `
                self.onmessage = function(e) {
                    if(e.data.cmd === 'hash') {
                        try {
                            importScripts('https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js');
                            const salt = dcodeIO.bcrypt.genSaltSync(e.data.cost);
                            const hash = dcodeIO.bcrypt.hashSync(e.data.pwd, salt);
                            self.postMessage({ok: true, hash: hash});
                        } catch(err) { self.postMessage({ok: false, err: err.toString()}); }
                    }
                };
            `;
            const blob = new Blob([code], {type: 'application/javascript'});
            bcryptWorker = new Worker(URL.createObjectURL(blob));
            bcryptWorker.onmessage = function(e) {
                const out = get('out-kdf');
                const stat = get('kdf-status');
                if(e.data.ok) {
                    out.innerText = e.data.hash;
                    stat.innerText = "Worker Idle";
                } else {
                    out.innerText = "Error: " + e.data.err;
                }
            };
        }

        // PBKDF2 (Native)
        async function runPBKDF2(pass, cost) {
            const enc = new TextEncoder();
            const salt = enc.encode("CryptoForgeSalt"); // Demo salt
            const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(pass), "PBKDF2", false, ["deriveBits"]);
            const bits = await crypto.subtle.deriveBits(
                { name: "PBKDF2", salt: salt, iterations: cost * 1000, hash: "SHA-256" },
                keyMaterial, 256
            );
            return [...new Uint8Array(bits)].map(b => b.toString(16).padStart(2,'0')).join('');
        }

        // Argon2 (External)
        async function runArgon2(pass, cost) {
            if(!window.argon2) return "Argon2 Lib Loading...";
            try {
                // Normalize cost for Argon2 demo
                const timeCost = Math.max(1, Math.floor(cost / 4));
                const hash = await argon2.hash({ 
                    pass: pass, salt: 'CryptoForgeSalt', 
                    time: timeCost, mem: 1024, parallelism: 1, type: argon2.Argon2id 
                });
                return hash.encoded;
            } catch(e) { return "Argon2 Error: " + e; }
        }

        // Password Router
        async function runKDF() {
            const pwd = get('pwd-input').value;
            const out = get('out-kdf');
            const stat = get('kdf-status');
            
            if(!pwd) { out.innerText = "Waiting..."; return; }
            out.innerText = "Calculating...";
            
            if(State.kdfMode === 'bcrypt') {
                if(!State.libsLoaded) { out.innerText = "Enable Libs for Bcrypt"; return; }
                stat.innerText = "Worker Running...";
                if(!bcryptWorker) initBcryptWorker();
                bcryptWorker.postMessage({cmd: 'hash', pwd: pwd, cost: State.currentCost});
            } 
            else if(State.kdfMode === 'pbkdf2') {
                // Native - no libs needed
                const res = await runPBKDF2(pwd, State.currentCost);
                out.innerText = res;
            }
            else if(State.kdfMode === 'argon2') {
                if(!State.libsLoaded) { out.innerText = "Enable Libs for Argon2"; return; }
                const res = await runArgon2(pwd, State.currentCost); 
                out.innerText = res;
            }
        }

        function setKDF(mode, el) {
            State.kdfMode = mode;
            document.querySelectorAll('#password-view .inner-tab').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            get('kdf-label').innerText = mode.toUpperCase();
            runKDF();
        }

        function setThreat(cost, el) {
            document.querySelectorAll('.threat-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            State.currentCost = cost;
            
            // Update Explanation
            const explain = get('threat-explain');
            if(cost === 10) explain.innerHTML = "<strong>Cost 10:</strong> Light hashing. Calculates in ~100ms. Suitable for development environments where speed is prioritized over maximum resistance.";
            else if(cost === 12) explain.innerHTML = "<strong>Cost 12:</strong> Standard hashing. Calculates in ~500ms. The default recommendation for most user identity systems.";
            else if(cost === 14) explain.innerHTML = "<strong>Cost 14:</strong> Heavy hashing. Calculates in ~1.5s. High CPU load. Use for root accounts, financial data, or API master keys.";

            runKDF();
        }

        // --- 5. HASHING (NATIVE + LEGACY) ---
        async function nativeHash(algo, data) {
            if(!data) return "";
            const buffer = (typeof data === 'string') ? new TextEncoder().encode(data) : data;
            const res = await crypto.subtle.digest(algo, buffer);
            return [...new Uint8Array(res)].map(b => b.toString(16).padStart(2,'0')).join('');
        }

        function libHash(algo, text) {
            if(!State.libsLoaded || typeof CryptoJS === 'undefined' || typeof text !== 'string') return "Libs Disabled / Text Only";
            try {
                if(algo === 'MD5') return CryptoJS.MD5(text).toString();
                if(algo === 'SHA3') return CryptoJS.SHA3(text, {outputLength: 256}).toString();
                if(algo === 'RIPEMD160') return CryptoJS.RIPEMD160(text).toString();
            } catch(e) { return "Error"; }
        }

        async function updateHashStudio(fileData = null) {
            let data = (State.hashMode === 'text') ? get('hash-input').value : fileData;
            
            // Native
            get('out-sha256').innerText = await nativeHash('SHA-256', data);
            get('out-sha512').innerText = await nativeHash('SHA-512', data);
            
            // Legacy
            if(State.hashMode === 'text') {
                get('out-sha3').innerText = libHash('SHA3', data);
                get('out-md5').innerText = libHash('MD5', data);
                get('out-ripemd').innerText = libHash('RIPEMD160', data);
            }
        }

        // --- 6. UI UTILS ---
        function switchTab(id, el) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            get(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            if(el) el.classList.add('active');
        }

        // SEARCH FUNCTIONALITY
        const searchInput = get('global-search');
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            if(!term) return;

            // Map keywords to tab IDs
            const mapping = {
                'hash': 'hash-view', 'sha': 'hash-view', 'md5': 'hash-view',
                'password': 'password-view', 'bcrypt': 'password-view', 'argon': 'password-view',
                'key': 'gen-view', 'uuid': 'gen-view', 'random': 'gen-view',
                'hmac': 'hmac-view', 'sign': 'hmac-view', 'jwt': 'hmac-view',
                'encode': 'utils-view', 'base64': 'utils-view', 'url': 'utils-view',
                'compare': 'compare-view', 'diff': 'compare-view'
            };

            for (const key in mapping) {
                if(key.includes(term) || term.includes(key)) {
                    const targetId = mapping[key];
                    const navEl = document.querySelector(`.nav-item[data-target="${targetId}"]`);
                    switchTab(targetId, navEl);
                    break; 
                }
            }
        });

        function toggleModal(id) {
            const m = get(id);
            m.classList.toggle('open');
        }

        async function copyToClipboard(text) {
            if(!text) return;
            let success = false;
            try {
                await navigator.clipboard.writeText(text);
                success = true;
            } catch (err) {
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-9999px";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    success = document.execCommand('copy');
                    document.body.removeChild(textArea);
                } catch (e) {
                    console.error("Copy failed", e);
                }
            }

            if (success) {
                const t = get('toast');
                t.classList.add('visible');
                setTimeout(() => t.classList.remove('visible'), 2000);
            }
        }

        function copy(id) {
            const txt = get(id).innerText;
            if(!txt || txt.includes("Wait") || txt.includes("Error")) return;
            copyToClipboard(txt);
        }

        function copyHashCLI(algo) {
            const input = get('hash-input').value || "INPUT_TEXT";
            // Escape double quotes for the shell argument
            const safeInput = input.replace(/"/g, '\\"');
            
            let nodeAlgo = algo;
            if(algo === 'SHA-3') nodeAlgo = 'sha3-256';
            if(algo === 'SHA-1') nodeAlgo = 'sha1';
            if(algo === 'SHA-256') nodeAlgo = 'sha256';
            if(algo === 'SHA-512') nodeAlgo = 'sha512';
            if(algo === 'MD5') nodeAlgo = 'md5';
            if(algo === 'RIPEMD-160') nodeAlgo = 'ripemd160';

            const cmd = `node -e "console.log(require('crypto').createHash('${nodeAlgo}').update(process.argv[1]).digest('hex'))" "${safeInput}"`;
            copyToClipboard(cmd);
        }

        function setHashMode(mode) {
            State.hashMode = mode;
            get('mode-text').classList.toggle('hidden', mode !== 'text');
            get('mode-file').classList.toggle('hidden', mode !== 'file');
            get('tab-text').classList.toggle('active', mode === 'text');
            get('tab-file').classList.toggle('active', mode === 'file');
            ['out-sha256','out-sha512','out-sha3','out-md5'].forEach(id => get(id).innerText = '');
        }

        // File Handling
        const dz = get('drop-zone');
        const fi = get('file-input');
        dz.onclick = () => fi.click();
        dz.ondragover = (e) => { e.preventDefault(); dz.classList.add('dragover'); };
        dz.ondragleave = () => dz.classList.remove('dragover');
        dz.ondrop = (e) => { e.preventDefault(); dz.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); };
        fi.onchange = (e) => handleFile(e.target.files[0]);

        function handleFile(file) {
            if(!file) return;
            get('file-info').innerText = `Loaded: ${file.name}`;
            const r = new FileReader();
            r.onload = (e) => updateHashStudio(e.target.result);
            r.readAsArrayBuffer(file);
        }
        
        // Utils
        function runEncoders() {
            const v = get('enc-input').value;
            if(!v) return;
            get('out-b64').innerText = btoa(v);
            get('out-url').innerText = encodeURIComponent(v);
        }

        function downloadReport() {
            let content = "CRYPTOFORGE PRO - HASH REPORT\n=============================\n\n";
            content += `Timestamp: ${new Date().toISOString()}\n\n`;
            content += "[HASH STUDIO]\n";
            content += `SHA-256: ${get('out-sha256').innerText}\n`;
            content += `SHA-512: ${get('out-sha512').innerText}\n`;
            if(State.libsLoaded) {
                 content += `SHA-3:   ${get('out-sha3').innerText}\n`;
                 content += `MD5:     ${get('out-md5').innerText}\n`;
            }

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cryptoforge-report.txt';
            a.click();
        }

        function hexToBinary(hex) {
            return hex.split('').map(char => parseInt(char, 16).toString(2).padStart(4, '0')).join('');
        }

        async function runCompare() {
            const a = get('comp-a').value;
            const b = get('comp-b').value;
            const grid = get('bit-grid');
            
            if(!a || !b) {
                grid.innerHTML = '';
                get('diff-pct').innerText = "0%";
                return;
            }

            const hashA = await nativeHash('SHA-256', a);
            const hashB = await nativeHash('SHA-256', b);
            const binA = hexToBinary(hashA);
            const binB = hexToBinary(hashB);

            grid.innerHTML = '';
            let diffCount = 0;
            // SHA-256 is 256 bits
            for(let i=0; i<256; i++) {
                const bit = document.createElement('div');
                bit.className = 'bit';
                if(binA[i] !== binB[i]) { 
                    bit.classList.add('diff'); 
                    diffCount++; 
                } else if (binA[i] === '1') { 
                    bit.classList.add('active'); 
                }
                grid.appendChild(bit);
            }
            const pct = Math.round((diffCount / 256) * 100);
            get('diff-pct').innerText = `${pct}% Difference`;
        }

        // Init
        // Check LocalStorage for Lib Preference
        if(localStorage.getItem('cf_libs') === 'true') {
            toggleZeroTrust(); // Auto-load if preferred
        } else {
            runCompare(); // Run visualizer initially if no libs needed
            genKey(32, 'b64', 'out-gen-enc'); // Init Key Lab
            genKey(32, 'hex', 'out-gen-hex');
            genUUID();
        }

        // Event Listeners
        const debounce = (fn) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), 300); } };
        get('hash-input').addEventListener('input', debounce(() => updateHashStudio()));
        get('hash-input').addEventListener('keydown', (e) => { if(e.ctrlKey && e.key === 'Enter') updateHashStudio(); });
        get('pwd-input').addEventListener('input', debounce(() => runKDF()));

    </script>
</body>
</html>
